name: Cerberus Council

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: cerberus-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    name: "${{ matrix.reviewer }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - reviewer: APOLLO
            perspective: correctness
          - reviewer: ATHENA
            perspective: architecture
          - reviewer: SENTINEL
            perspective: security
          - reviewer: VULCAN
            perspective: performance
          - reviewer: ARTEMIS
            perspective: maintainability
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install KimiCode CLI
        run: pip install kimi-cli

      - name: Get PR context
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr.diff
          echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "head=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "base=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT

      - name: Run ${{ matrix.reviewer }} review
        env:
          KIMI_API_KEY: ${{ secrets.MOONSHOT_API_KEY }}
          KIMI_BASE_URL: "https://api.moonshot.ai/v1"
          GH_PR_TITLE: ${{ steps.pr.outputs.title }}
          GH_PR_AUTHOR: ${{ steps.pr.outputs.author }}
          GH_PR_BODY: ${{ github.event.pull_request.body }}
          GH_HEAD_BRANCH: ${{ steps.pr.outputs.head }}
          GH_BASE_BRANCH: ${{ steps.pr.outputs.base }}
          GH_DIFF_FILE: /tmp/pr.diff
        run: |
          chmod +x .github/cerberus/scripts/run-reviewer.sh
          .github/cerberus/scripts/run-reviewer.sh ${{ matrix.perspective }}

      - name: Parse review output
        id: parse
        run: |
          python3 .github/cerberus/scripts/parse-review.py /tmp/${{ matrix.perspective }}-output.txt > /tmp/${{ matrix.perspective }}-verdict.json
          echo "verdict=$(jq -r .verdict /tmp/${{ matrix.perspective }}-verdict.json)" >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: always() && steps.parse.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          chmod +x .github/cerberus/scripts/post-comment.sh
          .github/cerberus/scripts/post-comment.sh ${{ matrix.perspective }} /tmp/${{ matrix.perspective }}-verdict.json

      - name: Upload verdict artifact
        if: always() && steps.parse.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: verdict-${{ matrix.perspective }}
          path: /tmp/${{ matrix.perspective }}-verdict.json

      - name: Check verdict
        if: always() && steps.parse.outcome == 'success'
        run: |
          VERDICT=$(jq -r .verdict /tmp/${{ matrix.perspective }}-verdict.json)
          if [ "$VERDICT" = "FAIL" ]; then
            echo "::error::${{ matrix.reviewer }} verdict: FAIL"
            exit 1
          fi

  verdict:
    name: "Council Verdict"
    needs: review
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download all verdicts
        uses: actions/download-artifact@v4
        with:
          path: ./verdicts/
          pattern: verdict-*
          merge-multiple: true

      - name: Check for override
        id: override
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
        run: |
          ACTOR_RULE="$(awk '/^  actor:/ {print $2; exit}' .github/cerberus/config.yml)"
          if [[ -z "$ACTOR_RULE" ]]; then
            ACTOR_RULE="pr_author"
          fi

          is_actor_allowed() {
            local actor="$1"
            local permission

            case "$ACTOR_RULE" in
              pr_author)
                [[ "$actor" == "$PR_AUTHOR" ]]
                ;;
              write_access)
                permission="$(gh api "repos/${REPO}/collaborators/${actor}/permission" --jq '.permission' 2>/dev/null || echo "none")"
                [[ "$permission" == "write" || "$permission" == "maintain" || "$permission" == "admin" ]]
                ;;
              maintainers_only)
                permission="$(gh api "repos/${REPO}/collaborators/${actor}/permission" --jq '.permission' 2>/dev/null || echo "none")"
                [[ "$permission" == "maintain" || "$permission" == "admin" ]]
                ;;
              *)
                false
                ;;
            esac
          }

          OVERRIDE=""
          while IFS= read -r raw; do
            actor="$(jq -r '.actor // ""' <<<"$raw")"
            if is_actor_allowed "$actor"; then
              OVERRIDE="$raw"
            fi
          done < <(
            gh pr view "$PR_NUMBER" --json comments \
              --jq '.comments[] | select(.body | startswith("/council override")) | {actor: .author.login, body: .body} | @json'
          )

          echo "override=$OVERRIDE" >> "$GITHUB_OUTPUT"

      - name: Aggregate verdicts
        env:
          GH_OVERRIDE_COMMENT: ${{ steps.override.outputs.override }}
          GH_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python3 .github/cerberus/scripts/aggregate-verdict.py ./verdicts/

      - name: Post council verdict
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          VERDICT=$(jq -r .verdict /tmp/council-verdict.json)
          SUMMARY=$(jq -r .summary /tmp/council-verdict.json)
          EMOJI="✅"
          if [ "$VERDICT" = "FAIL" ]; then EMOJI="❌"; fi
          if [ "$VERDICT" = "WARN" ]; then EMOJI="⚠️"; fi

          MARKER="<!-- cerberus:council -->"
          BODY="${MARKER}\n## ${EMOJI} Council Verdict: ${VERDICT}\n\n${SUMMARY}\n\n---\n*Cerberus Council*"

          EXISTING=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments --jq '.[] | select(.body | contains("cerberus:council")) | .id' | head -1)
          if [ -n "$EXISTING" ]; then
            gh api repos/${{ github.repository }}/issues/comments/$EXISTING -X PATCH -f body="$(echo -e "$BODY")"
          else
            gh pr comment $PR_NUMBER --body "$(echo -e "$BODY")"
          fi

      - name: Exit with verdict
        run: |
          VERDICT=$(jq -r .verdict /tmp/council-verdict.json)
          if [ "$VERDICT" = "FAIL" ]; then
            echo "::error::Council Verdict: FAIL"
            exit 1
          fi
